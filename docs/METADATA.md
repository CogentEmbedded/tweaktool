# Cogent Tweak Tool Metadata Format

## Introduction

The GUI application have to make decision about proper data editor for a tweak.
On the other hand, it is not desired to burden programmer with a lot of details.
Because of that, the algorithm should make reasonable assumptions about
preferable editor for each respective data type. For instance, the only
reasonable editor for a boolean variable is a checkbox. There are more options
for an integer variable, however: it could be a text field specialized to work
with numeric input. Or it could be a combobox or a radio button restricted to
several possible options. With these considerations, it's reasonable to assume
that boolean variables should work as expected out of box without configuration
at all, whilst configuration of scalar tweaks should be limited to setting value
ranges acceptable by variable associated with a tweak.

## Uses of Metadata

Metadata field is supplied by the user application when tweak is created. When it
is not supplied, some reasonable defaults are deduced from tweak type. It is
constant and cannot be changed in runtime after that.

Metadata is encoded in utf-8.

Metadata contains information for GUI to build rich user experience.

Metadata is serialized in JSON format.

String settings such as `"control": "slider"` are case sensitive.

Metadata format is designed for simple generation using concatenation of static
string templates.

## Readonly is the only common setting for all kinds of tweaks

Some values are naturally generated by a tweak server working on embedded
software. User shouldn't be allowed to alter it. Allowing user of GUI
application to change them is considered harmful. The code is designed to
be fool proof, but changing of data generated by server shall cause
unnecessary network data exchanges of data packets containing conflicting
values of tweak's value. Thus, a programmer should decide whether each
tweak is input or output. Input tweaks are being edited by GUI application,
output tweaks are being shown without providing interface to alter its value.
By default, each tweak is considered both input and output since at this
moment server API doesn't provide interface allowing to restrict write
operations on protocol level. If user wants a tweak to behave like an
output value in GUI application, one have to provide `readonly: true`
setting in metadata.

## Data types and default metadata

The only basis to make assumptions about default metadata values is data type.
There are three general flavours of data at the moment:

- Boolean values. Could be edited with a checkbox. Doesn't require any
  configuration, except maybe "readonly" setting for output boolean values
  to display some internal state on a board.

- Integer types. Typically, an editor for integer values works best when
  numeric range is defined, not allowing user to enter invalid values. Thus,
  user would want to explicitly set "min" and "max" settings in addition to
  "readonly" setting mentioned above. By default, min and max are deduced
  from data type. For instance, unsigned single word (`uint16_t`) have
  min=0 and max=65535 by default. User could also select "step" setting for
  editors allowing increment and decrement of numeric value. Default step
  for integers is 1.

- Floating point types. Edited more conveniently with special slider control.
  Decimal precision in decimals after dot and step for increment/decrement
  operations also to be configured by user. Convenient default min and max
  values couldn't be deduced for floating types.  However, GUI shouldn't behave
  erratically when no metadata is provided, thus ranges `-FLT_MAX`..`FLT_MAX`
  and `-DBL_MAX`..`DBL_MAX` are assumed for 32 bit and 64 bit floating point
  values, respectively. Default step for floating point values is set
  to `10^(-decimals)` whilst default value of `decimals` is 4. Thus, when both
  step and decimals settings are omitted, the step is set to `0.0001`.

## Custom editors

At this moment, only combobox with collection of exact discrete values could be
set only using metadata. Combobox couldn't be derived from tweak data type.
In order to get combobox control, user should create a tweak with integer
type and provide single "options" parameter whose value could be a string
array or a map.

## Data types

| Tweak type                | Data flavour |
|---------------------------|--------------|
| TWEAK_VARIANT_TYPE_NULL   | -            |
| TWEAK_VARIANT_TYPE_BOOL   | Boolean      |
| TWEAK_VARIANT_TYPE_SINT8  | Integer      |
| TWEAK_VARIANT_TYPE_SINT16 | Integer      |
| TWEAK_VARIANT_TYPE_SINT32 | Integer      |
| TWEAK_VARIANT_TYPE_SINT64 | Integer      |
| TWEAK_VARIANT_TYPE_UINT8  | Integer      |
| TWEAK_VARIANT_TYPE_UINT16 | Integer      |
| TWEAK_VARIANT_TYPE_UINT32 | Integer      |
| TWEAK_VARIANT_TYPE_UINT64 | Integer      |
| TWEAK_VARIANT_TYPE_FLOAT  | Float        |
| TWEAK_VARIANT_TYPE_DOUBLE | Float        |

*Note* Default values for "min" and "max" are deduced from bit width and
signedness of each tweak type. For floating point, `-FLT_MAX`..`FLT_MAX`
range is chosen, but it's advised to limit upper and lower value because
most editors work better when they have some information about
properties of of data being edited. Plus, user wouldn't be able to enter
invalid values.

## Metadata values applicable to configure editor of each respective data type

| Data flavour       | readonly | min | max | decimals | step | options | default editor |
|--------------------|----------|-----|-----|----------|------|---------|----------------|
| Boolean            | Y        | N   | N   | N        | N    | N       | checkbox       |
| Integer            | Y        | Y   | Y   | N        | Y    | Y       | spinbox        |
| Float              | Y        | Y   | Y   | Y        | Y    | N       | slider         |

*Note* "N" in this table means that setting shall be ignored and GUI warning shall be issued.

## Editor availability for each respective data flavour

User might use custom editor for some data flavours. For instance, he could
choose combobox with two options for a boolean variable.

| Data flavour       | checkbox | spinbox | slider | combobox |
|--------------------|----------|---------|--------|----------|
| Boolean            | Y        | Y       | N      | Y        |
| Integer            | N        | Y       | Y      | Y        |
| Float              | N        | Y       | Y      | N        |

*Note* Combobox could only be selected by providing "options" setting to metadata.

*Note* "N" in this table means that setting shall be ignored and, Qt warning
shall be issued, and default editor shall be used.

## Metadata JSON Format

Typical metadata contains:

```json
{
    // Control type, see below.
    "control": "slider",

    // Minimum value for slider or spinbox.
    "min": 55.6,

    // Maximum value for slider or spinbox.
    "max": 100.4,

    // Control is readonly i.e. values are passed
    //    [user app] -> [gui]
    // only.
    // Default value is false
    "readonly": false,

    // Default 1000/(max-min)
    // Number of decimal places (after the period).
    "decimals": 3,

    // Value added or subtracted from a variable when
    // user uses increment or decrement feature
    // in editor.
    // Default is 10^(-decimals)
    // Without this explicit setting metadata
    // calculator would choose .001 since "decimals"
    // setting is equal to 3
    "step": 0.1
}
```

For combobox controls where value equal to index of each respective string:

```json
{
    // Options for combobox control as Json array of strings
    "options": ["Foo", "Bar", "Baz"]
}
```

Here, selection of "Foo" in combobox sets tweak's value to 0,
"Bar" to 1, and "Baz" to 2.

User could also use provide associative map for sparse values:

```json
{
    // Options for combobox control as Json array of strings
    "options": [{"value": 100, "text": "Foo"},
                {"value": 110, "text": "Bar"},
                {"value": 120, "text":  "Baz"}]
}
```

Metadata for custom boolean editor.

```json
{
    // Options for combobox control as Json array of strings
    "options": [{"value": false, "text": "On"},
                {"value": true, "text": "Off"}]
}
```

## Examples

### Simple Bool Tweak

```json
{}
```

Could be NULL as well. GUI app will choose generic read/write checkbox to edit a tweak.

### Read-Only Bool Tweak

```json
{"readonly": true}
```

GUI app will display readonly on/off indicator.

### Advanced Bool Tweak

```json
{
    "options": [{"value": false, "text": "On"},
                {"value": true, "text": "Off"}]
}
```

GUI will use a combobox instead of default checkbox.

### Simple Integer Tweak

```json
{}
```

Could be NULL as well. GUI app will choose a generic read/write spinbox to edit a tweak.
For `int32` tweak, the lowest permitted value will be `INT32_MIN`, the highest one will be `INT32_MAX`.

### Read-Only Integer Tweak

```json
{"readonly": true}
```

GUI will display a number and wouldn't provide an interface to edit it.

### Limited-Range Integer Tweak

```json
{"min":-100,"max":100}
```

Simplest recommended way to configure an input field for a signed integer variable.
GUI app will choose a generic read/write spinbox to edit this tweak. Lowest value
permitted will be `-100`, the highest one will be `100`.

### Limited-Range Integer Tweak with a Step

```json
{
    "min": -100,
    "max": 100,
    "step": 10
}
```

Similar to previous, but increment and decrement button shall increment value
by `10`.

### Integer Tweak with a Slider

```json
{
    "control": "slider",
    "min": -1000,
    "max": 1000,
}
```

GUI will use a slider instead of the default spinbox to tune a value.

### Integer Tweak with Named Values (Enumeration)

```json
{
    "options": ["Front camera", "Right camera", "Left camera", "Rear camera" ]
}
```

GUI will display a combobox with four options mentioned in array supplied in
this json snippet. Value of the underlying variable corresponds to zero based
index in this array. This means, when user selects `Rear camera`, the value of
the integer tweak shall be set to `3` and when user selects `Front camera`,
the value of the integer tweak shall be set to `0`.

```json
{
    "control": "combobox",
    "options": ["Front camera", "Right camera", "Left camera", "Rear camera" ]
}
```

This configuration is identical to previous option, but contains redundant
`"control": "combobox"` setting since controls other than combobox for editing
enumerated values aren't supported in this release. Values other than "combobox"
will be rejected for enumerated value editor.

### Unsigned Integer Tweak

```json
{
    "max": 10000,
    "step": 100
}
```

Since the type of variable is unsigned one, "min" setting defaults to `0`. In other
regards, unsigned tweaks behave just like their signed counterparts.

### Float Tweak

```json
{
    "min": 55.6,
    "max": 100.4,
    "decimals": 3,
    "step": 0.1
}
```

This is a fully customized metadata for a floating point tweak. It has "min", "max",
"decimals" and "step" settings. This configuration would create a slider with
55.6.. 100.4 where precision is set to thousandths and increment/decrement buttons
shall skip to tenths fractions.
